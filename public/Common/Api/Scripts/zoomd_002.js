zdLogger=function(i,f,y){var t=this;this.clientId=f.clientId;this.currSocket=null;this.apiLogsToSend=[];this.ehLogsToSend=[];this.SU_LoggerServiceHttp="";this.SU_BaseUrlServiceHttp="";this.cookiesEnabled=u();this.timestamp=f.timestamp;this.initDate=f.startDate;var b=function(C){for(var D in C){if(C.hasOwnProperty(D)&&(C[D]===undefined||C[D]===""||C[D]===null)){delete C[D]}else{if(typeof(C[D])!="string"){C[D]=JSON.stringify(C[D])}}}};d(f.initialToken);this.addIframeCont=function(D,F){t.SU_LoggerServiceHttp="";var C="";var E="";if(window.Zoomd&&Zoomd.Widget&&Zoomd.Widget.SU_BaseUrlContentHttp){E=SphereUp.SphereUpWidget.SU_BaseUrlContentHttp}if(window.Zoomd&&Zoomd.Widget&&Zoomd.Widget.SU_LoggerServiceHttp){t.SU_LoggerServiceHttp=Zoomd.Widget.SU_LoggerServiceHttp;t.SU_BaseUrlServiceHttp=Zoomd.Widget.SU_BaseUrlServiceHttp;C=t.SU_LoggerServiceHttp+"?clientId="+encodeURIComponent(D)+"&contentSource="+encodeURIComponent(E)}else{y.LogError("zoomd injector is not available, failed to load logger",{clientId:D});return}B(D,C);if(F){F()}};function B(D,C){if(i("body").length>0){i('<iframe id="zd_log" data-zd_clid="'+D+'" src="'+C+'" frameborder="0" width="1px" height="1px" style="visibility:none;position:absolute;"></iframe>').appendTo(i("body")).on("load",function(){t.currSocket=this.contentWindow;if(t.apiLogsToSend){i.each(t.apiLogsToSend,function(E,F){j(F)})}t.apiLogsToSend=[]})}else{setTimeout(B,100,D,C)}}function g(D){var E=D.action;var G;try{G=JSON.stringify(D)}catch(F){y.LogError("zdLogger: error when stringify event data.",{exception:F.message,clientId:t.clientId});return}var C=E+"<<action/data>>"+G;if(t.currSocket){j(C)}else{t.apiLogsToSend.push(C)}}this.checkCompatabilityFunctions=function(){if(!Date.prototype.toISOString){(function(){function C(E){var D=String(E);if(D.length===1){D="0"+D}return D}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+C(this.getUTCMonth()+1)+"-"+C(this.getUTCDate())+"T"+C(this.getUTCHours())+":"+C(this.getUTCMinutes())+":"+C(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1000).toFixed(3)).slice(2,5)+"Z"}}())}};function u(){var C=navigator.cookieEnabled;if(!C){document.cookie="testcookie";C=document.cookie.indexOf("testcookie")!=-1}return C}function r(D,F,C){var E="expires="+C.toUTCString();document.cookie=D+"="+F+";"+E+";path=/"}function a(D){var F=D+"=";var C=document.cookie.split(";");for(var E=0;E<C.length;E++){var G=C[E];while(G.charAt(0)==" "){G=G.substring(1,G.length)}if(G.indexOf(F)==0){return G.substring(F.length,G.length)}}return null}function w(C){var D=new Date();D.setTime(D.getTime()+30*60*60*1000);r("zdSessionId_"+t.clientId,C,D)}function x(){var C=a("zdSessionId_"+f.clientId);if(!C){C=y.generateUuid();w(C)}return C}function l(F){if(F&&t.SU_BaseUrlServiceHttp.indexOf(F.origin)>-1&&typeof(F.data)=="string"){var E=F.data.split("{:}");if(E[0]){var C=E[0].split(":");if(C[0]=="ZoomdWidgetLogger"){var D={};switch(C[1]){case"StartSession":try{D=JSON.parse(E[3])}catch(F){}t.startSession(E[1],E[2],D);break;case"StopSession":t.stopSession(E[1]);break;case"LogEvent":try{D=JSON.parse(E[2])}catch(F){}t.logEvent(E[1],D,E[3]);break;case"SetTime":t.setTime(E[1]);break}}}}}this.init=function(D){var C=function(){return{clientId:f.clientId,clientSiteUrl:(document.URL),clientPageTitle:i("head > title",document).text(),zoom:y.getZoom(),sessionId:f.sessionId,resolution:screen.availWidth+"X"+screen.availHeight,language:f.Language,referrer:document.referrer,userId:f.userId,abGroup:f.abGroup,userAgent:navigator.userAgent||navigator.vendor||window.opera||"",environment:f.environment,widgetMinorVersion:f.widgetVersion,platform:f.Platform?f.Platform:"",ver:f.Version,injectorVersion:f.injectorVersion,abTesting:f.Platform==="codefuel"?"perion":"zoomd",clientIpAddress:f.clientIpAddress,isMobile:window.matchMedia("only screen and (max-width: 760px)").matches,cookiesEnabled:t.cookiesEnabled}};if(window.addEventListener){window.addEventListener("message",l,false)}else{window.attachEvent("onmessage",l)}this.startSession("PageSession","sessionId",C());t.checkCompatabilityFunctions();t.addIframeCont(t.clientId,function(){if(D){D()}});e();return t};function j(C){t.currSocket.postMessage(C,t.SU_LoggerServiceHttp)}function v(G){if(f.EventsTargetsMappings==null||f.EventsTargetsMappings.length==0||f.EventsTargetsMappings.some(function(I){return I.match.action==="*"})==false){g(G)}var F=f.EventsTargetsMappings.filter(function(I){return Object.keys(I.match).every(function(J){return G[J]===I.match[J]||I.match[J]==="*"})});for(var E=0;E<F.length;++E){var C=F[E].targets;if(C.length==0){g(G)}for(var D=0;D<C.length;++D){var H=C[D];switch(H.type){case"API":g(G);break;case"EventHubs":h(G);break;case"Adobe":A(G,H);break}}}}function A(F,I){if(i.isFunction(window.s_gi)&&window.s&&typeof(window.s)=="object"&&i.isFunction(window.s.track)){var G=Object.keys(I.action);if(G.length>0){for(var C=0;C<G.length;++C){var K=G[C];var J=I.action[K];if(/event\.(\w+)/.test(J)){var H=J;var E=new RegExp(/event\.(\w+)/g);var D,M,L;while((M=E.exec(H))!==null){D=M[1];L=F[D]||"";J=J.replace(M[0],L)}}window.s[K]=J}window.s.track()}}}function h(E){try{var C=s();if(!C){t.ehLogsToSend.push(E);p();return}var D=f.eventHubsEndpoint+"/messages";i.ajax({url:D,method:"POST",contentType:"application/atom+xml;type=entry;charset=utf-8",crossDomain:true,headers:{Authorization:C,sourcesenderId:"3",clientId:'"'+t.clientId+'"',action:E.action},data:JSON.stringify(E),error:function(G,I,H){y.LogError("zdLogger: general error sending to events hub.",{errorThrown:H,statusText:I,clientId:t.clientId,action:E.action,requestUrl:D,token:C})}})}catch(F){y.LogError("zdLogger: error sending to events hub.",{exception:F.message,clientId:t.clientId,action:E.action,requestUrl:D,token:C})}}function s(){return t.cookiesEnabled?a(t.clientId+"-ehtoken"):t.token}function d(C){var D=new Date(C.expires.match(/\d+/)[0]*1);if(t.cookiesEnabled){r(t.clientId+"-ehtoken",C.token,D)}else{t.token=C.token;setTimeout(function(){t.token=null},D.getTime()-new Date().getTime())}}function k(){if(t.ehLogsToSend){i.each(t.ehLogsToSend,function(C,D){h(D)})}t.ehLogsToSend=[]}function p(){var C="";if(window.Zoomd&&Zoomd.Widget&&Zoomd.Widget.SU_BaseUrlServiceHttp){C=Zoomd.Widget.SU_BaseUrlServiceHttp}if(C===""){return}i.ajax({url:C+"zoomd/SearchUi/GetToken",data:{clientId:t.clientId},crossDomain:true,method:"POST",success:function(D){if(D){if(D!="error"){d(D);k()}}},error:function(D){y.LogError("zdLogger: error refreshing token.",{error:D,clientId:t.clientId,url:C,events:t.ehLogsToSend})}})}var o=[];this.setTime=function(C){o[C]=(new Date()).getTime()};var z=function(C){if(o[C]){return((new Date()).getTime()-o[C])*0.001}return null};var c={order:[]};var q=function(){var C=c.PageSession;if(C){if(C.zoom){C.zoom=y.getZoom()}if(C.isMobile){C.isMobile=window.matchMedia("only screen and (max-width: 760px)").matches}}};var e=function(){i(window).resize(function(){q()})};this.startSession=function(D,C,E){if(c[D]){this.stopSession(D)}c[D]={};this.setTime(D);c[D].parameters=E||{};c[D].parameters[C]=c[D].__id=y.generateUuid();c.order.push(D);return c[D].parameters[C]};this.updateSession=function(D,F,E){if(!c[D]||c[D].__id!==F){return false}var C=c[D].parameters;c[D].parameters=i.extend({},C,E);return c[D].__id};this.stopSession=function(C){if(c[C]){c[C]=undefined;c.order=c.order.filter(function(D){if(D===C){return false}return true});return true}return false};var m=function(){var D={};if(c.order.length>0){var E="";for(var C=0;C<c.order.length;C++){E=c.order[C];if(c[E]&&c[E].parameters){D=i.extend({},D,c[E].parameters)}}}return D};this.logEvent=function(F,D,E){D=D||{};if(typeof(D)!="object"){return false}if(E){var H=z(E);if(H){D.timeSeconds=H}}D.startTime=new Date().toISOString();D.rk=n();var C=m();D=i.extend({},C,D);D.siteSessionId=x();D.action=F;b(D);if(f.EventsTargetsMappings&&f.EventsTargetsMappings.length>0){try{v(D)}catch(G){g(D);y.LogError("zdLogger: processEventsTargets failed.",{exception:G.message,clientId:t.clientId})}}else{g(D)}return true};this.getSessionParameters=function(C){var D=m();return i.extend({},D,C||{})};function n(){var C=t.initDate.getTime()-new Date().getTime();return t.timestamp+(C*1000)+y.generateUuid().substring(0,8)}return t};